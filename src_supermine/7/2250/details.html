<html><h3>fafc6c60d9534f2036af61a1f3ead9e81070762f,server/bert_serving/server/benchmark.py,,run_benchmark,#Any#,33
</h3><link rel="stylesheet" href="../../../../default.css">
<script src="../../../../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>

    &#47&#47 select those non-empty test cases
    all_exp_names = [k.replace(&quottest_&quot, &quot&quot) for k, v in vars(args).items() if k.startswith(&quottest_&quot) and v]
    <a id="change">fw = open(&quotbenchmark-%d%s.result&quot % (args.num_worker, &quot-fp16&quot if args.fp16 else &quot&quot), &quotw&quot)</a>
    for exp_name in all_exp_names:
        &#47&#47 set common args
        cargs = deepcopy(args)
        exp_vars = vars(args)[&quottest_%s&quot % exp_name]
        avg_speed = []

        for cvar in exp_vars:
            &#47&#47 override exp args
            setattr(cargs, exp_name, cvar)
            server = BertServer(cargs)
            server.start()
            time.sleep(cargs.wait_till_ready)

            &#47&#47 sleep until server is ready
            all_clients = [BenchmarkClient(cargs, vocab) for _ in range(cargs.num_client)]
            for bc in all_clients:
                bc.start()

            clients_speed = []
            for bc in all_clients:
                bc.join()
                clients_speed.append(cargs.client_batch_size / bc.avg_time)
            server.close()

            max_speed, min_speed, cavg_speed = int(max(clients_speed)), int(min(clients_speed)), int(
                mean(clients_speed))

            print(&quotavg speed: %d\tmax speed: %d\tmin speed: %d&quot % (cavg_speed, max_speed, min_speed), flush=True)

            avg_speed.append(cavg_speed)

        print(&quot\n|`%s`\t|samples/s|\n|---|---|&quot % exp_name, file=fw)
        for cvar, cavg_speed in zip(exp_vars, avg_speed):
            print(&quot|%s\t|%d|&quot % (cvar, cavg_speed), file=fw)
        &#47&#47 for additional plotting
        print(&quot\n%s = %s\n%s = %s&quot % (exp_name, exp_vars, &quotspeed&quot, avg_speed), file=fw)
    <a id="change">fw.close()</a>
</code></pre><h3>After Change</h3><pre><code class='java'>

            avg_speed.append(cavg_speed)

        <a id="change">with open(&quotbenchmark-%d%s.result&quot % (args.num_worker, &quot-fp16&quot if args.fp16 else &quot&quot), &quota&quot) as fw:
            print(&quot\n|`%s`\t|samples/s|\n|---|---|&quot % exp_name, file=fw)
            for cvar, cavg_speed in zip(exp_vars, avg_speed):
                print(&quot|%s\t|%d|&quot % (cvar, cavg_speed), file=fw)
            &#47&#47 for additional plotting
            print(&quot\n%s = %s\n%s = %s&quot % (exp_name, exp_vars, &quotspeed&quot, avg_speed), file=fw)</a>
</code></pre><img src="11810023.png" alt="Italian Trulli"   style="width:500px;height:500px;"><div id='inPattern'>In pattern: SUPERPATTERN</div><BR><div id='frequency'>Frequency: 6</div><BR><div id='size'>Non-data size: 6</div><BR><h3>Instances</h3><BR><div id='link'><a href='https://github.com/hanxiao/bert-as-service/commit/fafc6c60d9534f2036af61a1f3ead9e81070762f#diff-b57927beacaee243272638f590a388536fc9b63dd1be33d2c351b06a4c595b9eL44' target='_blank'>Link</a></div><div id='project'> Project Name: hanxiao/bert-as-service</div><div id='commit'> Commit Name: fafc6c60d9534f2036af61a1f3ead9e81070762f</div><div id='time'> Time: 2019-01-22</div><div id='author'> Author: hanhxiao@tencent.com</div><div id='file'> File Name: server/bert_serving/server/benchmark.py</div><div id='class'> Class Name: </div><div id='method'> Method Name: run_benchmark</div><BR><BR><div id='link'><a href='https://github.com/keras-team/keras/commit/4cde148de0c37981c50f3a8e4a59fa4e5f653e17#diff-f4c7ccd4c776ce6db4bca7c4c59a7f45f733278c29ef22ddf69a56c67b2bc1faL41' target='_blank'>Link</a></div><div id='project'> Project Name: keras-team/keras</div><div id='commit'> Commit Name: 4cde148de0c37981c50f3a8e4a59fa4e5f653e17</div><div id='time'> Time: 2018-02-04</div><div id='author'> Author: bohumir.zamecnik@gmail.com</div><div id='file'> File Name: examples/pretrained_word_embeddings.py</div><div id='class'> Class Name: </div><div id='method'> Method Name: </div><BR><BR><div id='link'><a href='https://github.com/deepmipt/DeepPavlov/commit/8261994bf8f77251f0b22fb13fa490ffa0bd184b#diff-b82e57261a34d59549a7f0d9143b814a564d243ab755447fac8332604032309cL83' target='_blank'>Link</a></div><div id='project'> Project Name: deepmipt/DeepPavlov</div><div id='commit'> Commit Name: 8261994bf8f77251f0b22fb13fa490ffa0bd184b</div><div id='time'> Time: 2018-02-01</div><div id='author'> Author: yoptar@gmail.com</div><div id='file'> File Name: deeppavlov/core/data/utils.py</div><div id='class'> Class Name: </div><div id='method'> Method Name: ungzip</div><BR><BR><div id='link'><a href='https://github.com/NervanaSystems/nlp-architect/commit/4b674552c6755a5b154927b0cf86aa4812729ec4#diff-6a885683e668acf31e80ef3a783f0deba076fc98a974ff198068ac38c7b17eb8L52' target='_blank'>Link</a></div><div id='project'> Project Name: NervanaSystems/nlp-architect</div><div id='commit'> Commit Name: 4b674552c6755a5b154927b0cf86aa4812729ec4</div><div id='time'> Time: 2018-05-14</div><div id='author'> Author: daniel.korat@intel.com</div><div id='file'> File Name: examples/most_common_word_sense/prepare_data.py</div><div id='class'> Class Name: </div><div id='method'> Method Name: read_gs_file</div><BR><BR><div id='link'><a href='https://github.com/NervanaSystems/nlp-architect/commit/4d8cca40654deb641809bf8fb376afd9b1633d52#diff-70821eaf4da5ca1beb735b9b367307e20c3bebf6552eb07af59629958df3cf18L167' target='_blank'>Link</a></div><div id='project'> Project Name: NervanaSystems/nlp-architect</div><div id='commit'> Commit Name: 4d8cca40654deb641809bf8fb376afd9b1633d52</div><div id='time'> Time: 2019-03-31</div><div id='author'> Author: daniel.korat@intel.com</div><div id='file'> File Name: nlp_architect/data/ptb.py</div><div id='class'> Class Name: PTBDictionary</div><div id='method'> Method Name: _uncompress_data</div><BR><BR><div id='link'><a href='https://github.com/NervanaSystems/nlp-architect/commit/3b27baf2719698ffe600ff3d33b10c04d2e39f33#diff-d60073a8ee55b6062e03d7ee14dae0d77f7ebbae1ecf96b0d6529bf1289795c3L33' target='_blank'>Link</a></div><div id='project'> Project Name: NervanaSystems/nlp-architect</div><div id='commit'> Commit Name: 3b27baf2719698ffe600ff3d33b10c04d2e39f33</div><div id='time'> Time: 2018-07-16</div><div id='author'> Author: jonathan.mamou@intel.com</div><div id='file'> File Name: solutions/set_expansion/prepare_data.py</div><div id='class'> Class Name: </div><div id='method'> Method Name: </div><BR>