<link rel="stylesheet" href="../default.css">
<script src="../highlight.pack.js"></script> 
<script>hljs.initHighlightingOnLoad();</script>
<html><h3></h3><h3>Before Change</h3><pre><code class='java'>
    hash = sha_constructor(settings.SECRET_KEY + sql + params).hexdigest()
    if hash != request.GET.get('hash', ''):
        return HttpResponseBadRequest('Tamper alert') # SQL Tampering alert
    if <a id="change">sql</a>.lower().startswith('select'):
        params = simplejson.loads(params)
        cursor = connection.cursor()
        cursor.execute("SET PROFILING=1") # Enable profiling</code></pre><h3>After Change</h3><pre><code class='java'>
    hash = sha_constructor(settings.SECRET_KEY + sql + params).hexdigest()
    if hash != request.GET.get('hash', ''):
        return HttpResponseBadRequest('Tamper alert') # SQL Tampering alert
    if <a id="change">sql</a>.lower().strip().startswith('select'):
        params = simplejson.loads(params)
        cursor = connection.cursor()
        cursor.execute("SET PROFILING=1") # Enable profiling
        cursor.execute(sql, params) # Execute SELECT
        cursor.execute("SET PROFILING=0") # Disable profiling
        # The Query ID should always be 1 here but I'll subselect to get the last one just in case...
        cursor.execute("SELECT * FROM information_schema.profiling WHERE query_id=(SELECT query_id FROM information_schema.profiling ORDER BY query_id DESC LIMIT 1)")
        headers = [d[0] for d in cursor.description]
        result = cursor.fetchall()
        cursor.close()
        context = {
            'result': result,
            'sql': reformat_sql(cursor.db.ops.last_executed_query(cursor, sql, params)),
            'time': request.GET.get('time', 0.0),
            'headers': headers,
        }
        return render_to_response('debug_toolbar/panels/sql_explain.html', context)
    <a id="change">raise InvalidSQLError("Only 'select' queries are allowed.")</a>

def template_source(request):
    """
    Return the source of a template, syntax-highlighted by Pygments if</code></pre>